# NIT Manual
# Добавление компьютера в Active Directory

## Введение

Для тестирования программ в условиях максимального приближения к реальной офисной работе необходимо, чтобы тестируемый компьютер находился в домене Active Directory компьютерной сети. В случае, когда в сети нет контроллера домена, его можно поднять на виртуальной машине. Но тогда будет желательно также размещать тестируемые машины на виртуальных машинах. В данном руководстве рассмотрим требования для присоединения к домену гостевой виртуальной машины, работающей на гипервизоре VMWare.

## Исходные данные

На учебном стенде развёрнута локальная сеть с выходом в глобальную сеть Интернет. В сети есть роутер, одновременно являющийся DHCP сервером, раздающим IPv4 адреса. В сети также присутствует подсеть IPv6 с распределением IP адресов по технологии Slaac. Это типичная конфигурация домашнего офиса.

В сети есть несколько серверов, которым присвоены псевдо-статичные IPv4 адреса. На одном из таких физических серверов расположен DNS сервер, опеределяющий имена в домене *.internal*. DNS сервер распределяет как IPv4, так и IPv6 LinkLocal адреса. На одном из компьютеров установлен гипервизор Hyper-V, на другом — VMWare Workstation.

На гипервизоре Hyper-V установлена гостевая операционная система Microsoft Windows 2012R2. Он имеет статичный IPv4 адрес. В нём установлены роли поддержка AD и DNS Server, никак не связанный с DNS сервером в локальной сети. На этом сервере поднят контроллер домена.

Контроллер домена имеет учётные записи контроллера домена *Администратор* и непривилегированную учётную запись члена домена. Домен имеет FQDN леса *peter.yuden.local* и имя NetBIOS *PETER*. Дополнительной защиты и делегирования доменов не заданы.

На сервере также установлены: поддержка сервисов удалённого доступа,  консольные утилиты манипулирования файлов, ьменеджеры пакетов, Windows Management Framework 5.1, .Net Framework 3.5 и 4.8, дополнения VC++ Redist. Это упрощает доставку и выполнение скриптов администрирования Active Directory, но несколько портит "чистоту" тестирования (поскольку многие критические для выполнения пейлоад пакеты уже установлены).

В процессе тестирования на гостевой операционной системе в Hyper-V, на DNS сервере были установлены вручную адреса для виртуальных машин Hyper-VV и VMWare Workstation. Притом, что на DNS сервере в локальной сети эти компьютеры прописаны не были, хъотя им был впоследствии назначены статические IPv4 адреса. Как это повлияло на результаты присоединения компьютеров к домену — неизвестно (это было сделано "на всякий случай"). Обратная зона на контроллере домена *не создавалась*.

На VMWare Workstation были установлены гостевые Microsofgt Windows 7 и 10. Установлены они были с модифицированного образа, применёные к ним настройки были минимальные, и не включали средства удалённого управления компьютером. Впоследствии это серьёзно затруднило отладку скриптов присоединения к домену.

## Результаты испытания

Для начала была испытана возможность подключения к домену гостевой Microsoft Windows 7 Максимальная как менее требовательной к ресурсам. Из-за того, что в неё не был установлен Windows Management Frameworks 5.1 скрипт подсоединения к домену пришлось много раз переписывать, но в итоге он всё равно не заработал. Информации по скриптам мало именно из-за окончания поддержки PowerShell 2.0. Поэтому пришлось подсоединять компьютер к домену стандартным путём, через GUI оснастку.

### Алгоритм присоединения компьютера к домену

1. С помощью средств разведки опеределяем имя и IP адреса контроллера домена (он же DNS сервер) и подключаемого компьютера.
2. Делаем эти адреса статичными (!). Без этого сеть Windows работать не будет.
3. На DNS сервере контролллера домена заводим записи типа "A" (типа AAAA не тестировались) для указанных компьютеров. Запись для контроллера домена создаётся автоматически при его создании, остальныен записи желательно добавить вручную.
4. На контроллере домена создаём учётные записи локальных пользователей домена (на всякий случай, чтобы потом было меньше работы). В них будут входить пользователи после присоединения компьютеров в домены.
5. Проверить, что в свойствах сетевого адаптера (интерфейса) указана опция «NetBIOS over TCP/IP». Без этого работоспособность сети Windowsневозможна. По умолчанию он включён для сетей с Windows.
6. Потом необходимо перейти на подключаемый компьютер.
7. В нём необходимо открыть свойтства адптера и также проверить настройку «NetBIOS over TCP/IP».
8. Потом в настройках адаптера можно отключить протокол IPv6. Это необходимо *обязательно сделать*, если вы не настроили работу контроллера домена по протоколу IPv6. *Примечание*/ Как компромисc возможно отключение поддержки DNS на протоколеIPv6.
9. Затем нужно зайти в настройки протокола IPv4, выбрать опцию «Использовать указанные DNS сервера», в качестве первичного сервера указать DNS сервер контроллера домена, а остальные DNS-сервера отключить. Это нужно сделать **обязательно**! В противном случае DNS сервера будут назначаться из локальной сети и DHCP-сервера, что не позволит развернуть доменную сеть.
10. Далее нужно проверить, что Интернет-соединение у Вас не разорвалось. Если это не так, устраните неполадки в работе DNS сервера контроллера домена (проблемы с рекурсией или делегированием зон).
11. Для проверки правильности настройки сети и DNS необходимо в командной строке подключаемого компьютера набрать следующие команды:

```
nltest /dsgetdc:<netbios domain name> /force

и 

nltest /dsgetdc:<DNS domain name> /force
```

В нашем случае это было

```
nltest /dsgetdc:PETER /force

nltest /dsgetdc:peter.yuden.local /force
```

Если хотя бы один из этих тестов завершится ошибкой, необходимо проверить разрешение доменных имён (командами `ping.exe`, `tracert.exe`, `nslookup.exe` и `dig.exe`). Они дадут испчерпывающую информацию о проблемах с доступностью узлов и разрешением их имён. ДЛя исправления часто бывает достаточно удалить «лишний» DNS сервер или поменять миестами порядок их опроса. Иногда требуется больше действий, если DNS-сервера неправильно настроены.

12. Перейдите к присоединению компьютера к домену через графичиескую консоль.


#### Подключение компьютера к домену через графическую консоль

1. Откройте диалоговое окно «Система», вкладка «Изменение имени компьютера» (Инструмент «Параметры Компьютера» или «Панель управления»).
2. Нажмите на ней кнопку «Изменить».
3. Выберите переключатель «Является членом *домена*».
4. Введите FQDN (предпочтительнее) или NetBIOS имя домена (у нас будет PETER).
5. Нажмите кнопку «Ok».
6. Введите учётные данные кнтроллера домена для подтверждения.
7. Нажмите кнопку «Ok» и ожидайте.
8. В случае успешного присоединения к домену будет выведено соответствующее предупреждение ипредложена перезагрузка компьютера.
9. После перезагрузки войдие в одну из известных учётных записей домена на присоеднёном комьютере.
10. Бинго!

#### Подключение компьютера к домену с помощью скрипта

1. Загрузите на компьютер скрипт.
2. Измените в нём иммя домена и контроллера домена на свои.
3. Запустите скрипт, подставив учётную запись контроллера домена в качестве пеараметра Credential.
4. После успешного применения перезагрузите компьютер.

*Внимание!!!* Выбирайте версию скрипта под вашу версию Powershell.

##### Profit! Можете приступать к тестированию Ваших сетоевых продуктов.

